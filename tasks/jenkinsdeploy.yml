---
#- name: Start Jiiify's Jenkins build
#  script: trigger-jenkins.sh {{ jiiify_jenkins_auth }} {{ jiiify_build_token }} {{ jiiify_env }}.library.ucla.edu {{ secret_files[jiiify_env]['github_branch'] }} {{ secret_files[jiiify_env]['s3_bucketname'] }}
#  no_log: True

#- name: Download Jiiify
#  shell: wget --user=ksclarke --password={{ jiiify_jenkins_auth }} -O /opt/jiiify/jiiify-{{ jiiify_version }}-exec.jar --auth-no-challenge https://jenkins.library.ucla.edu/job/jiiify-image-server/ws/target/jiiify-{{ jiiify_version }}-exec.jar
#  no_log: True

- name: Download Jiiify
  shell: wget https://s3-us-west-2.amazonaws.com/build-artifacts.library.ucla.edu/jiiify/{{ secret_files[jiiify_env]['github_branch'] }}/{{ secret_files[jiiify_env]['jiiify_vers'] }} -O /opt/jiiify/{{ secret_files[jiiify_env]['jiiify_vers'] }}

- name: Set file attributes for Jar file
  file: path=/opt/jiiify/{{ secret_files[jiiify_env]['jiiify_vers'] }} owner=jiiify mode=0600 state=file

# Using unzip instead of unarchive because we're only unzippping one particular file
- name: Unpack Jiiify raw supervisord.conf file
  shell: unzip -o -d /tmp /opt/jiiify/{{ secret_files[jiiify_env]['jiiify_vers'] }} supervisord.conf

# Upload supervisord.conf
- name: Upload supervisord.conf
  template: src=supervisord.conf.j2 dest=/etc/supervisord.conf owner=root group=root mode=0600

- name: Upload JSON config file
  template: src=config.json.j2 dest=/etc/jiiify/config.json owner=jiiify group=jiiify mode=0600
  no_log: True
  
- name: Set supervisord.conf file attributes
  file: path=/etc/supervisord.conf mode=0600 state=file
  notify:
    - create supervisord socket
    - restart supervisord